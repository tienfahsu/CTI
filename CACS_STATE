  DECLARE @R_DATE AS DATETIME

   SET @R_DATE= DATEADD(Day,-1,GETDATE())

   IF OBJECT_ID('tempdb..#IDRP_BASE_EX') IS NOT NULL DROP TABLE #IDRP_BASE_EX
   IF OBJECT_ID('tempdb..#CHK_STATE') IS NOT NULL DROP TABLE #CHK_STATE

   	DECLARE @FF TABLE
	(	
		 PRG varchar(16)
		,PROCDATE date
		,IDNO varchar(10)
		,CARDNMBR varchar(16)
		,ORI_STATE varchar(3)
		,CACS_STATE varchar(3) -- to_state	 
		
	)

	 DELETE FROM UIDRP_DO_NOT_STATE WHERE CARDNMBR IS NULL
		 
	
	--停催案件
	--前置協商
	;WITH ZZM200
	AS
	(
	    --若有多筆則取procdate最大一筆
		SELECT A.IDN,[dbo].TRANS_YMD(A.RC_DATE) RC_DATE FROM
		(SELECT IDN,RC_DATE, PROCDATE, ROW_NUMBER() OVER (PARTITION BY IDN ORDER BY PROCDATE DESC) AS SEQNO FROM UIDRP_Z92_ZZM200) A
		WHERE A.SEQNO =1 AND A.PROCDATE >= CAST(DATEADD(Day,-3,@R_DATE) AS DATE)	 
	)	
	,IDRP_BASE_EX
	AS
	(
		 SELECT ID_TAG,CARDNMBR,CACS_STATE,RMS_STATUS,CARD_IND, ROW_NUMBER() OVER (PARTITION BY cardnmbr ORDER BY IIF(cardblock IS NULL,1,0) DESC) AS SEQNO  	 
		 FROM COGDB3.dbo.IDRP_BASE	
		 WHERE (SUBSTRING(RMS_STATUS,1,1)<>'9' OR SUBSTRING(RMS_STATUS,1,2) IN ('96','98'))
			AND CARD_IND='P' 
			AND PRODTYPE NOT IN ('ML','MP')
			AND CARDNMBR IN (SELECT CARDNMBR FROM dbo.DS_REC_COMBO_VW) 
			AND SUBSTRING(CACS_STATE,1,1) NOT IN ('Y','N') AND SUBSTRING(CACS_STATE,1,2) NOT IN ('G7','G8') AND CACS_STATE NOT IN ('G99','S97','S98','S91')
	)
	INSERT INTO @FF (PRG,PROCDATE,IDNO,CARDNMBR,ORI_STATE,CACS_STATE)
	SELECT 'WCHK_STOP_COLL'AS PRG, GETDATE(), M.IDNO, B.CARDNMBR, B.CACS_STATE AS ORI_STATE,''
	FROM ZZM200 A  
    INNER JOIN UIDRP_IDRP_FULL_BASE_VW M ON M.IDNO=A.IDN AND M.REQ_DEBT_D=A.RC_DATE AND M.FAIL_D IS NULL --並排除IDN & REQ_DEBT_D= RC_DATE 在UIDRP_DE_IDRP_CUSTINFO的fail_d不為NULL
	INNER JOIN IDRP_BASE_EX B ON M.IDNO=B.ID_TAG AND B.SEQNO=1 
	UNION ALL --前置調解
	SELECT 'WCHK_STOP_COLL'AS PRG, GETDATE(), M.IDNO, B.CARDNMBR, B.CACS_STATE AS ORI_STATE,''
	FROM  UIDRP_IDRP_FULL_BASE_VW M 	 
	INNER JOIN IDRP_BASE_EX B ON M.IDNO=B.ID_TAG AND B.SEQNO=1  
	WHERE M.IF_COMM='Y' AND M.FAIL_D IS NULL  



	--簽約完成案件
	;WITH CARDS_BUDTRAN_TKD
	AS
	(
		SELECT CUSTID,CARDNMBR,CACS_STATE FROM dbo.DS_CARDS_VW WHERE ([LOCATION] NOT IN ('860103','860104') OR SUBSTRING(CACS_STATE,1,1) IN ('V','Q','S'))
		  AND (SUBSTRING(CACS_STATE,1,1) NOT IN ('Y','N') AND CACS_STATE NOT IN ('S97','S98','S91','G99','S36','S37'))
		UNION ALL 
		SELECT CUSTID,CARDNMBR,CACS_STATE FROM dbo.DS_BUDTRAN_VW  WHERE([LOCATION] NOT IN ('860103','860104') OR SUBSTRING(CACS_STATE,1,1) IN ('V','Q','S'))
		  AND (SUBSTRING(CACS_STATE,1,1) NOT IN ('Y','N') AND CACS_STATE NOT IN ('S97','S98','S91','G99','S36','S37'))
	) 
	INSERT INTO @FF (PRG,PROCDATE,IDNO,CARDNMBR,ORI_STATE,CACS_STATE)
	SELECT 'WCHK_TKD'AS PRG,GETDATE(), A.CUSTID AS IDNO, B.CARDNMBR, B.CACS_STATE AS ORI_STATE,'' AS CACS_STATE
	FROM UIDRP_CUS_IDRP_CUSTINFO A
	INNER JOIN CARDS_BUDTRAN_TKD B ON A.CUSTID=B.custid
	LEFT JOIN UIDRP_IDRP_FULL_BASE_VW M ON M.IDNO=A.CUSTID AND CAST(M.REQ_DEBT_D AS DATE)=A.DOCDATE AND M.FAIL_D IS NOT NULL  
	WHERE M.IDNO IS NULL
	--WHERE A.CUSTID+CONVERT(varchar(10),A.DOCDATE,111) NOT IN (SELECT M.IDNO+CONVERT(varchar(10),M.REQ_DEBT_D,111) FROM UIDRP_IDRP_FULL_BASE_VW M WHERE M.REQ_DEBT_D IS NOT NULL AND M.FAIL_D IS NOT NULL)

 


	--覆催案件
	--前置協商
	;WITH ZZM203
	AS
	(
	    --若有多筆則取procdate最大一筆
		SELECT A.IDN,[dbo].TRANS_YMD(A.RC_DATE) RC_DATE FROM
		(SELECT IDN,RC_DATE, PROCDATE, ROW_NUMBER() OVER (PARTITION BY IDN ORDER BY PROCDATE DESC) AS SEQNO FROM UIDRP_Z92_ZZM203) A
		WHERE A.SEQNO =1 AND A.PROCDATE >= CAST(DATEADD(Day,-3,@R_DATE) AS DATE)	 
	)	
	,CARDS_BUDTRAN_RESUME
	AS
	(
		SELECT CUSTID,CARDNMBR,CACS_STATE FROM dbo.DS_CARDS_VW WHERE (SUBSTRING(CACS_STATE,1,1) IN ('Y','N') OR SUBSTRING(CACS_STATE,1,2) IN ('G7','G8') OR CACS_STATE  IN ('G99'))
		UNION ALL 
		SELECT CUSTID,CARDNMBR,CACS_STATE FROM dbo.DS_BUDTRAN_VW  WHERE (SUBSTRING(CACS_STATE,1,1) IN ('Y','N')  OR SUBSTRING(CACS_STATE,1,2) IN ('G7','G8') OR CACS_STATE IN ('G99'))
	) 	 
	INSERT INTO @FF (PRG,PROCDATE,IDNO,CARDNMBR,ORI_STATE,CACS_STATE)
	SELECT 'WCHK_RESUME_COLL' AS PRG,GETDATE(), A.IDN AS IDNO, B.CARDNMBR, B.CACS_STATE AS ORI_STATE,'' AS CACS_STATE
	FROM ZZM203 A  
	INNER JOIN CARDS_BUDTRAN_RESUME B ON A.IDN=B.custid

	--前置調解
	;WITH CARDS_BUDTRAN_RESUMEX
	AS
	(
		SELECT CUSTID,CARDNMBR,CACS_STATE FROM dbo.DS_CARDS_VW WHERE  (SUBSTRING(CACS_STATE,1,1) IN ('Y','N') OR SUBSTRING(CACS_STATE,1,2) IN ('G7','G8') OR CACS_STATE  IN ('G99'))
		UNION ALL 
		SELECT CUSTID,CARDNMBR,CACS_STATE FROM dbo.DS_BUDTRAN_VW  WHERE  (SUBSTRING(CACS_STATE,1,1) IN ('Y','N')  OR SUBSTRING(CACS_STATE,1,2) IN ('G7','G8') OR CACS_STATE IN ('G99'))
	) 	 
	INSERT INTO @FF (PRG,PROCDATE,IDNO,CARDNMBR,ORI_STATE,CACS_STATE)
	SELECT 'WCHK_RESUME_COLL' AS PRG,GETDATE(), M.IDNO, B.CARDNMBR, B.CACS_STATE AS ORI_STATE,
	CASE WHEN SUBSTRING(CACS_STATE,1,2)='G7' AND  FAIL_RESN IN ('11','12','13','14','15','16','17','18','19','21','49') THEN 'G74'
	     WHEN SUBSTRING(CACS_STATE,1,2)='G7' THEN 'G76'
		 WHEN SUBSTRING(CACS_STATE,1,2)='G8' THEN 'G86'
		 WHEN SUBSTRING(CACS_STATE,1,1)='N' THEN 'N41' ELSE '' END AS CACS_STATE
    FROM  UIDRP_IDRP_FULL_BASE_VW M 	
	INNER JOIN CARDS_BUDTRAN_RESUMEX B ON M.IDNO=B.custid
	WHERE M.IF_COMM='Y' AND FAIL_D IS NOT NULL 
	AND CAST(FAIL_D AS DATE) >= CAST(DATEADD(DAY,-3,GETDATE()) AS DATE)
	AND FAIL_RESN IS NOT NULL AND FAIL_RESN <> '99' 
	  
 
 
	 
 
   SELECT PRG,PROCDATE,IDNO,CARDNMBR,ORI_STATE,CACS_STATE FROM @FF  
